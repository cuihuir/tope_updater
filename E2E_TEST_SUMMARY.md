# E2E æµ‹è¯•è§„åˆ’æ€»ç»“

**åˆ›å»ºæ—¥æœŸ**: 2026-01-14
**çŠ¶æ€**: ğŸ“‹ è§„åˆ’å®Œæˆï¼Œå¾…å®æ–½

---

## âœ… å·²å®Œæˆçš„å·¥ä½œ

### 1. ğŸ“‹ E2E æµ‹è¯•è§„åˆ’æ–‡æ¡£
**æ–‡ä»¶**: `specs/001-updater-core/e2e-test-plan.md`

**å†…å®¹æ¦‚è¦**:
- E2E æµ‹è¯•æ¦‚è¿°å’Œç›®æ ‡
- æµ‹è¯•ç¯å¢ƒå‡†å¤‡æ–¹æ¡ˆï¼ˆDocker / æœ¬åœ° / çœŸå®è®¾å¤‡ï¼‰
- **15 ä¸ªæµ‹è¯•åœºæ™¯**è®¾è®¡ï¼Œæ¶µç›–:
  - æ ¸å¿ƒæµç¨‹ï¼ˆP0ï¼‰: 5 ä¸ªåœºæ™¯
  - é”™è¯¯å¤„ç†ï¼ˆP1ï¼‰: 4 ä¸ªåœºæ™¯
  - è¾¹ç•Œæƒ…å†µï¼ˆP2ï¼‰: 4 ä¸ªåœºæ™¯
  - é«˜çº§åŠŸèƒ½ï¼ˆP3ï¼‰: 2 ä¸ªåœºæ™¯
- **5 ä¸ªå®æ–½é˜¶æ®µ**ï¼Œé¢„è®¡æ€»è€—æ—¶ **5-6 å°æ—¶**
- æµ‹è¯•æ•°æ®å‡†å¤‡æ–¹æ¡ˆ
- Mock æœåŠ¡å™¨éœ€æ±‚è¯´æ˜
- CI/CD é›†æˆç¤ºä¾‹

**å…³é”®äº®ç‚¹**:
- å®Œæ•´çš„åœºæ™¯è®¾è®¡ï¼Œè¦†ç›– Happy Path åˆ°é”™è¯¯æ¢å¤
- Docker ç¯å¢ƒæ”¯æŒï¼Œä¾¿äº CI/CD é›†æˆ
- è¯¦ç»†çš„æˆåŠŸæ ‡å‡†å’Œé£é™©åˆ†æ

---

### 2. ğŸ§ª E2E æµ‹è¯•æ¡†æ¶æ­å»º
**æ–‡ä»¶**: `tests/e2e/conftest.py`

**æ ¸å¿ƒåŠŸèƒ½**:
- âœ… `setup_test_environment`: è‡ªåŠ¨åˆ›å»ºæµ‹è¯•ç›®å½•
- âœ… `mock_servers`: å¯åŠ¨/åœæ­¢ mock æœåŠ¡å™¨ï¼ˆpackage server + device-apiï¼‰
- âœ… `updater_service`: è‡ªåŠ¨å¯åŠ¨/åœæ­¢ updater æœåŠ¡
- âœ… `http_client`: æä¾› async HTTP å®¢æˆ·ç«¯
- âœ… `sample_test_package`: è‡ªåŠ¨ç”Ÿæˆæµ‹è¯•åŒ…
- âœ… `reset_state`: è‡ªåŠ¨æ¸…ç† state.json
- âœ… `wait_for_stage()`: å·¥å…·å‡½æ•°ï¼Œç­‰å¾…ç‰¹å®šé˜¶æ®µ

**ä»£ç ç»Ÿè®¡**: ~330 è¡Œï¼Œå®Œæ•´ fixtures å’Œå·¥å…·å‡½æ•°

---

### 3. ğŸ¯ åŸºç¡€ E2E æµ‹è¯•ç¤ºä¾‹
**æ–‡ä»¶**: `tests/e2e/test_happy_path.py`

**å·²å®ç°æµ‹è¯•**:
| æµ‹è¯•ç”¨ä¾‹ | æè¿° | çŠ¶æ€ |
|---------|------|------|
| `test_updater_service_health` | éªŒè¯æœåŠ¡å¯åŠ¨å’Œå¥åº·æ£€æŸ¥ | âœ… |
| `test_simple_api_call` | éªŒè¯ API ç«¯ç‚¹å¯è®¿é—®æ€§ | âœ… |
| `test_idle_state_after_startup` | éªŒè¯å¯åŠ¨åå¤„äº IDLE çŠ¶æ€ | âœ… |
| `test_download_request_acceptance` | éªŒè¯ä¸‹è½½ API æ¥å—è¯·æ±‚ | âœ… |
| `test_progress_polling` | éªŒè¯è¿›åº¦è½®è¯¢ | âœ… |
| `test_error_handling_invalid_request` | éªŒè¯é”™è¯¯å¤„ç† | âœ… |
| `test_concurrent_download_requests` | éªŒè¯å¹¶å‘è¯·æ±‚å¤„ç† | âœ… |
| `test_debug_environment` | è°ƒè¯•ç¯å¢ƒæ£€æŸ¥ | âœ… |

**ä»£ç ç»Ÿè®¡**: ~200 è¡Œï¼Œ8 ä¸ªå¯è¿è¡Œçš„æµ‹è¯•

---

### 4. ğŸ“– E2E æµ‹è¯•æ–‡æ¡£
**æ–‡ä»¶**: `tests/e2e/README.md`

**å†…å®¹**:
- å‰ç½®æ¡ä»¶å’Œå®‰è£…æ­¥éª¤
- å¿«é€Ÿå¼€å§‹æŒ‡å—
- æµ‹è¯•ç”¨ä¾‹æ¸…å•
- ç¼–å†™æ–°æµ‹è¯•çš„æ¨¡æ¿å’Œç¤ºä¾‹
- Fixtures ä½¿ç”¨æŒ‡å—
- å·¥å…·å‡½æ•°æ–‡æ¡£
- æ•…éšœæ’æŸ¥æŒ‡å—ï¼ˆ5 ä¸ªå¸¸è§é—®é¢˜ï¼‰
- CI/CD é›†æˆç¤ºä¾‹
- æœ€ä½³å®è·µï¼ˆ5 æ¡å»ºè®®ï¼‰

---

### 5. ğŸ“ ä»»åŠ¡æ¸…å•æ›´æ–°
**æ–‡ä»¶**: `specs/001-updater-core/tasks.md`

**æ–°å¢ä»»åŠ¡**:
- **T070**: E2E æµ‹è¯•åŸºç¡€è®¾æ–½ âœ… (å·²å®Œæˆ)
- **T071**: Happy path E2E æµ‹è¯• âœ… (éƒ¨åˆ†å®Œæˆ)
- **T072**: é”™è¯¯åœºæ™¯ E2E æµ‹è¯• â³ (å¾…å®ç°)
- **T073**: éƒ¨ç½²å›æ»š E2E æµ‹è¯• â³ (å¾…å®ç°)
- **T074**: çŠ¶æ€æ¢å¤ E2E æµ‹è¯• â³ (å¾…å®ç°)
- **T075**: E2E æµ‹è¯•æ–‡æ¡£ âœ… (å·²å®Œæˆ)

**ä»»åŠ¡æ€»æ•°æ›´æ–°**: 74 â†’ 80 (+6 E2E ä»»åŠ¡)

---

## ğŸ“Š å®æ–½è®¡åˆ’

### Phase 1: åŸºç¡€è®¾æ–½ âœ… å·²å®Œæˆ
- âœ… E2E æµ‹è¯•æ¡†æ¶ (`conftest.py`)
- âœ… Mock æœåŠ¡å™¨é›†æˆ
- âœ… æµ‹è¯•æ•°æ®ç”Ÿæˆ
- âœ… åŸºç¡€æµ‹è¯•ç¤ºä¾‹
- âœ… æ–‡æ¡£å®Œæ•´

**è€—æ—¶**: å®é™…çº¦ 2 å°æ—¶

---

### Phase 2: æ ¸å¿ƒåœºæ™¯ â³ å¾…å®æ–½ï¼ˆé¢„è®¡ 2-3 å°æ—¶ï¼‰

**ç›®æ ‡**: å®ç°å®Œæ•´çš„ OTA æ›´æ–°æµç¨‹æµ‹è¯•

**æµ‹è¯•ç”¨ä¾‹**:
1. **E2E-001**: æ­£å¸¸æ›´æ–°æµç¨‹ï¼ˆå®Œæ•´ä¸‹è½½ + éƒ¨ç½²ï¼‰
   - ä¸‹è½½ 10MB æµ‹è¯•åŒ…
   - MD5 éªŒè¯
   - éƒ¨ç½²åˆ°ç›®æ ‡ä½ç½®
   - éªŒè¯æœ€ç»ˆçŠ¶æ€ SUCCESS

2. **E2E-002**: MD5 æ ¡éªŒå¤±è´¥
   - å‡†å¤‡ MD5 ä¸åŒ¹é…çš„åŒ…
   - éªŒè¯é”™è¯¯å¤„ç†
   - éªŒè¯æ–‡ä»¶æ¸…ç†

3. **E2E-003**: åŒ…å¤§å°ä¸åŒ¹é…
   - Mock Content-Length é”™è¯¯
   - éªŒè¯ PACKAGE_SIZE_MISMATCH é”™è¯¯

4. **E2E-004**: éƒ¨ç½²å¤±è´¥å›æ»š
   - å‡†å¤‡æŸåçš„åŒ…ï¼ˆæƒé™é”™è¯¯ï¼‰
   - éªŒè¯è‡ªåŠ¨å›æ»š
   - éªŒè¯å¤‡ä»½æ¢å¤

5. **E2E-005**: çŠ¶æ€æ¢å¤
   - ä¸‹è½½ä¸­æ–­åé‡å¯æœåŠ¡
   - éªŒè¯çŠ¶æ€æ¸…ç†
   - éªŒè¯å¯é‡æ–°ä¸‹è½½

**äº¤ä»˜ç‰©**:
- `tests/e2e/test_full_ota_flow.py`
- 5 ä¸ªæ ¸å¿ƒæµ‹è¯•é€šè¿‡
- æµ‹è¯•è¦†ç›–ç‡ > 70%

---

### Phase 3: é”™è¯¯å¤„ç† â³ å¾…å®æ–½ï¼ˆé¢„è®¡ 1-2 å°æ—¶ï¼‰

**æµ‹è¯•ç”¨ä¾‹**:
1. **E2E-006**: ç½‘ç»œè¿æ¥è¶…æ—¶
2. **E2E-007**: HTTP 404 å¤„ç†
3. **E2E-008**: HTTP 503 å¤„ç†
4. **E2E-009**: è¿›åº¦æŠ¥å‘Šå‡†ç¡®æ€§

**äº¤ä»˜ç‰©**:
- `tests/e2e/test_network_errors.py`
- `tests/e2e/test_progress_reporting.py`
- 4 ä¸ªé”™è¯¯å¤„ç†æµ‹è¯•é€šè¿‡

---

### Phase 4: è¾¹ç•Œæƒ…å†µ â³ å¾…å®æ–½ï¼ˆé¢„è®¡ 1-2 å°æ—¶ï¼‰

**æµ‹è¯•ç”¨ä¾‹**:
1. **E2E-010**: å¹¶å‘è¯·æ±‚å¤„ç†
2. **E2E-011**: ä¸‹è½½ä¸­æ–­æ¢å¤
3. **E2E-012**: ç£ç›˜ç©ºé—´ä¸è¶³
4. **E2E-013**: æƒé™é”™è¯¯å¤„ç†

**äº¤ä»˜ç‰©**:
- `tests/e2e/test_edge_cases.py`
- 4 ä¸ªè¾¹ç•Œæµ‹è¯•é€šè¿‡

---

### Phase 5: é«˜çº§åŠŸèƒ½ â³ å¾…å®æ–½ï¼ˆå¯é€‰ï¼Œ1-2 å°æ—¶ï¼‰

**æµ‹è¯•ç”¨ä¾‹**:
1. **E2E-014**: systemd é›†æˆ
2. **E2E-015**: device-api å›è°ƒ

**äº¤ä»˜ç‰©**:
- `tests/e2e/test_systemd_integration.py`
- `tests/e2e/test_device_api_callbacks.py`

---

## ğŸ¯ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

### ç«‹å³è¡ŒåŠ¨ï¼ˆæ˜å¤©å¼€å§‹ï¼‰

1. **è¿è¡Œç°æœ‰ E2E æµ‹è¯•**
   ```bash
   # ç”Ÿæˆæµ‹è¯•åŒ…
   python tests/fixtures/generate_test_packages.py

   # è¿è¡ŒåŸºç¡€æµ‹è¯•
   pytest tests/e2e/test_happy_path.py -v -s
   ```

2. **å®æ–½ Phase 2: æ ¸å¿ƒåœºæ™¯**
   - å®ç° `E2E-001`: å®Œæ•´ OTA æµç¨‹æµ‹è¯•
   - å®ç° `E2E-002` ~ `E2E-005`: é”™è¯¯åœºæ™¯æµ‹è¯•
   - ç›®æ ‡: 5 ä¸ªæ ¸å¿ƒæµ‹è¯•é€šè¿‡

3. **éªŒè¯å’Œä¿®å¤**
   - ä¿®å¤å‘ç°çš„ bug
   - æ›´æ–°æµ‹è¯•æ–‡æ¡£
   - æäº¤ä»£ç 

### æœ¬å‘¨ç›®æ ‡

- âœ… å®Œæˆ Phase 2ï¼ˆæ ¸å¿ƒåœºæ™¯ï¼‰
- â³ å¼€å§‹ Phase 3ï¼ˆé”™è¯¯å¤„ç†ï¼‰
- â³ æµ‹è¯•è¦†ç›–ç‡ > 75%

### æœ¬æœˆç›®æ ‡

- âœ… å®Œæˆ Phase 1-4ï¼ˆæ‰€æœ‰ P0 + P1 æµ‹è¯•ï¼‰
- â³ CI/CD é›†æˆå®Œæˆ
- â³ å‡†å¤‡ç”Ÿäº§éƒ¨ç½²

---

## ğŸ“ æ–‡ä»¶æ¸…å•

### æ–°å¢æ–‡ä»¶

```
specs/001-updater-core/
â””â”€â”€ e2e-test-plan.md              # E2E æµ‹è¯•è§„åˆ’ï¼ˆ~800 è¡Œï¼‰

tests/e2e/
â”œâ”€â”€ __init__.py                   # åŒ…æ ‡è¯†
â”œâ”€â”€ conftest.py                   # æµ‹è¯•æ¡†æ¶å’Œ fixturesï¼ˆ~330 è¡Œï¼‰
â”œâ”€â”€ test_happy_path.py            # åŸºç¡€æµ‹è¯•ç¤ºä¾‹ï¼ˆ~200 è¡Œï¼‰
â”œâ”€â”€ README.md                     # E2E æµ‹è¯•æ–‡æ¡£ï¼ˆ~500 è¡Œï¼‰
â””â”€â”€ test_data/                    # æµ‹è¯•æ•°æ®ç›®å½•
    â””â”€â”€ packages/                 # æµ‹è¯•åŒ…å­˜æ”¾å¤„
```

### ä¿®æ”¹æ–‡ä»¶

```
specs/001-updater-core/
â””â”€â”€ tasks.md                      # æ·»åŠ  E2E æµ‹è¯•ä»»åŠ¡ï¼ˆT070-T075ï¼‰
```

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [E2E æµ‹è¯•è¯¦ç»†è§„åˆ’](../specs/001-updater-core/e2e-test-plan.md)
- [E2E æµ‹è¯• README](../tests/e2e/README.md)
- [æµ‹è¯•åŸºç¡€è®¾æ–½æŒ‡å—](../specs/001-updater-core/testing-guide.md)
- [ä»»åŠ¡æ¸…å•](../specs/001-updater-core/tasks.md)

---

## ğŸ’¡ å…³é”®å†³ç­–

### 1. æµ‹è¯•ç¯å¢ƒé€‰æ‹©
**å†³ç­–**: ä¼˜å…ˆä½¿ç”¨æœ¬åœ°ç¯å¢ƒï¼ŒDocker ä½œä¸ºå¯é€‰é¡¹
**åŸå› **:
- æœ¬åœ°ç¯å¢ƒç®€å•å¿«é€Ÿï¼Œé€‚åˆå¼€å‘è¿­ä»£
- Docker ç”¨äº CI/CDï¼Œä¿è¯ä¸€è‡´æ€§
- çœŸå®è®¾å¤‡æµ‹è¯•å»¶ååˆ°ç”Ÿäº§å‰éªŒè¯

### 2. Mock ç­–ç•¥
**å†³ç­–**: ä½¿ç”¨è½»é‡çº§ Python mock æœåŠ¡å™¨
**åŸå› **:
- FastAPI å®ç°ç®€å•ï¼Œæ˜“äºå®šåˆ¶
- å¯æ³¨å…¥é”™è¯¯åœºæ™¯
- æ— éœ€é¢å¤–ä¾èµ–

### 3. æµ‹è¯•æ•°æ®ç®¡ç†
**å†³ç­–**: è‡ªåŠ¨ç”Ÿæˆ + é¢„ç”Ÿæˆæ··åˆ
**åŸå› **:
- å°åŒ…è‡ªåŠ¨ç”Ÿæˆï¼ˆçµæ´»ï¼‰
- å¤§åŒ…é¢„ç”Ÿæˆï¼ˆèŠ‚çœæ—¶é—´ï¼‰
- æ”¯æŒé”™è¯¯åœºæ™¯å®šåˆ¶

### 4. æœåŠ¡éš”ç¦»
**å†³ç­–**: æ¯ä¸ªæµ‹è¯•ç‹¬ç«‹å¯åŠ¨/åœæ­¢ updater æœåŠ¡
**åŸå› **:
- æµ‹è¯•éš”ç¦»ï¼Œæ— çŠ¶æ€æ±¡æŸ“
- å¯é æ€§é«˜
- ç•¥æ…¢ä½†å€¼å¾—

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### è¿è¡Œç°æœ‰æµ‹è¯•

```bash
# 1. ç¡®ä¿ä¾èµ–å·²å®‰è£…
uv sync --dev

# 2. ç”Ÿæˆæµ‹è¯•åŒ…
python tests/fixtures/generate_test_packages.py

# 3. è¿è¡Œ E2E æµ‹è¯•
pytest tests/e2e/test_happy_path.py -v -s
```

### ç¼–å†™æ–°æµ‹è¯•

```python
# tests/e2e/test_my_scenario.py
import pytest

@pytest.mark.e2e
@pytest.mark.asyncio
async def test_my_scenario(http_client, sample_test_package):
    """Test my scenario."""
    # 1. Setup
    # 2. Execute
    # 3. Verify
    pass
```

---

**æœ€åæ›´æ–°**: 2026-01-14
**ä¸‹æ¬¡æ›´æ–°**: Phase 2 å®Œæˆå
**è´Ÿè´£äºº**: æµ‹è¯•å›¢é˜Ÿ
