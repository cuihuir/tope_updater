# Implementation Plan: Updater Core OTA Program

**Branch**: `001-updater-core` | **Date**: 2025-11-26 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/001-updater-core/spec.md`

**Note**: This document was generated by the `/speckit.plan` command. See `.specify/templates/commands/plan.md` for the execution workflow.

## Summary

Implement a bulletproof OTA updater service for embedded 3D printer devices. The updater runs as a systemd service, exposes HTTP API endpoints for triggering downloads and installations, implements resumable downloads with MD5 verification, performs atomic file deployment, and safely controls process lifecycle. Uses FastAPI for async HTTP server, httpx for downloads, and communicates with device-api via HTTP callbacks while serving ota-gui via polling endpoint.

## Technical Context

**Language/Version**: Python 3.11+
**Primary Dependencies**: FastAPI 0.115.0 (async HTTP server), uvicorn 0.32.0 (ASGI server), httpx 0.27.0 (async HTTP client), Python standard library (zipfile, hashlib, os, signal)
**Storage**: Local filesystem - ./tmp/ (temp downloads, state persistence), ./logs/ (rotating logs), ./backups/ (rollback support)
**Testing**: pytest with pytest-asyncio for async tests, httpx AsyncClient for HTTP endpoint testing
**Target Platform**: Linux embedded device (ARM/x86), systemd-based init, Python 3.11+ installed
**Project Type**: Single Python service (backend daemon)
**Performance Goals**: <100ms GET /progress response, <500ms callback latency to device-api, <50MB RAM peak usage, 10Mbps network → 100MB package in <5min
**Constraints**: Runs as root (process control + file deployment to system dirs), hardcoded ports (updater:12315, device-api:9080), must survive power failures mid-update
**Scale/Scope**: Single-device deployment, handles 1 OTA operation at a time, supports packages up to ~500MB, 3-5 modules per update

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

### ✅ Principle I: Core Mission (Prime Directive)
**Status**: PASS
**Check**: Feature scope limited to: download, verify (MD5), deploy (atomic file ops), process control (SIGTERM/SIGKILL), HTTP API for command/status. No business logic beyond OTA.

### ⚠️ Principle II: Minimal Dependencies
**Status**: CONDITIONAL PASS - Requires justification
**Violation**: Uses third-party libraries FastAPI, uvicorn, httpx (~15-20 packages total) instead of Python standard library `http.server` + `urllib`
**Justification** (from spec FR-029 + clarification):
- **Performance**: FastAPI's async model prevents blocking when handling concurrent requests (device-api download commands + ota-gui progress polling). Standard library `http.server` uses threading model requiring manual lock management.
- **Compatibility**: httpx provides async HTTP Range requests for resumable downloads; `urllib` would require blocking I/O or complex threading.
- **Security/Reliability**: Pydantic (FastAPI dependency) validates request payloads automatically, reducing error-prone manual validation code.
- **Constitution Clause**: Principle II allows exceptions "with security/performance/compatibility rationale" — met here.

**Re-evaluation after Phase 1**: Will verify that no additional dependencies are introduced beyond FastAPI/uvicorn/httpx.

### ✅ Principle III: Idempotent Operations
**Status**: PASS
**Check**: FR-001a specifies `/download` endpoint is idempotent (checks state.json, resumes if same package_url). FR-010 atomic file deployment (write temp → verify → rename). FR-024/025 startup recovery from incomplete operations.

### ✅ Principle IV: Atomic File Operations
**Status**: PASS
**Check**: FR-010 mandates temp file → MD5 verification → `rename()` syscall for atomic commit. FR-011 backup before replacement. FR-032 creates ./backups/ directory.

### ✅ Principle V: Mandatory MD5 Verification
**Status**: PASS
**Check**: FR-004 computes MD5 hash of downloaded package. FR-005 aborts on mismatch with `MD5_MISMATCH` error. FR-001b verifies MD5 before installation. No skip mechanism.

### ✅ Principle VI: Manifest-Driven Deployment
**Status**: PASS
**Check**: FR-007 parses manifest.json from package root. FR-008 validates paths (rejects `..` and unauthorized absolute paths). FR-009 creates missing target directories. FR-014 deploys in manifest-specified dependency order.

### ✅ Principle VII: Safe Process Control
**Status**: PASS
**Check**: FR-012 sends SIGTERM, waits 10 seconds, then SIGKILL if needed. FR-013 verifies termination via `/proc/<pid>`. FR-014 restarts in dependency order (device-api first). FR-020 reports process control failures.

### ✅ Principle VIII: Resumable Operations (断点续传)
**Status**: PASS
**Check**: FR-003 implements HTTP Range-based resumable downloads. FR-025 resumes from state.json byte position. FR-026 falls back to full download if state corrupted.

### ✅ Principle IX: Resource Protection
**Status**: PASS
**Check**: FR-021 streams downloads to disk (no RAM buffering). SC-009 targets <50MB RAM peak. Uses async I/O to avoid blocking. FR-018 rotates logs at 10MB to prevent disk exhaustion.

### ✅ Principle X: Comprehensive Error Reporting
**Status**: PASS
**Check**: FR-016 POSTs errors to device-api `/api/v1.0/ota/report` with error codes (`MD5_MISMATCH`, `DISK_FULL`, `INVALID_MANIFEST`, etc.). FR-020 includes descriptive messages. FR-005 reports errors before aborting.

### ✅ Principle XI: Structured Logging
**Status**: PASS
**Check**: FR-017 logs to `./logs/updater.log`. FR-018 rotates at 10MB, keeps 3 rotations. FR-019 includes ISO 8601 timestamps and DEBUG/INFO/WARN/ERROR levels.

### ✅ Principle XII: Bilingual Documentation
**Status**: PASS
**Check**: Spec exists in both `spec.md` (English) and `spec_cn.md` (Chinese). Plan will also be provided in both languages.

**Final Gate Status**: ✅ PASS with one justified exception (Principle II - FastAPI/httpx usage justified by performance/compatibility).

## Project Structure

### Documentation (this feature)

```text
specs/001-updater-core/
├── plan.md              # This file (/speckit.plan output)
├── plan_cn.md           # Chinese version (Principle XII)
├── research.md          # Phase 0 output (technology decisions)
├── data-model.md        # Phase 1 output (state machines, entities)
├── quickstart.md        # Phase 1 output (dev setup)
├── contracts/           # Phase 1 output (OpenAPI specs)
│   ├── updater-api.yaml # Updater HTTP API (port 12315)
│   └── device-api-callbacks.yaml # device-api callback contract (port 9080)
└── tasks.md             # Phase 2 output (/speckit.tasks - NOT created by /speckit.plan)
```

### Source Code (repository root)

```text
# Single Python project structure
src/
├── updater/
│   ├── __init__.py
│   ├── main.py              # FastAPI app + uvicorn startup
│   ├── api/
│   │   ├── __init__.py
│   │   ├── endpoints.py     # POST /download, POST /update, GET /progress
│   │   └── models.py        # Pydantic request/response models
│   ├── services/
│   │   ├── __init__.py
│   │   ├── download.py      # Async download with httpx, Range support
│   │   ├── verification.py  # MD5 computation
│   │   ├── deployment.py    # Atomic file operations, manifest parsing
│   │   ├── process_control.py # SIGTERM/SIGKILL, /proc checks
│   │   └── state_manager.py # state.json persistence, status state
│   ├── models/
│   │   ├── __init__.py
│   │   ├── manifest.py      # Manifest data structure
│   │   ├── state.py         # State file structure
│   │   └── status.py        # Status enum (idle/downloading/etc)
│   └── utils/
│       ├── __init__.py
│       ├── logging.py       # Rotating logger setup
│       └── callbacks.py     # HTTP POST to device-api

tests/
├── unit/
│   ├── test_download.py
│   ├── test_verification.py
│   ├── test_deployment.py
│   ├── test_process_control.py
│   └── test_state_manager.py
├── integration/
│   ├── test_full_ota_flow.py
│   ├── test_resume_download.py
│   └── test_power_failure_simulation.py
└── contract/
    ├── test_api_endpoints.py # Validate OpenAPI contract
    └── test_device_api_callbacks.py

# Deployment files (repository root)
deploy/
├── tope-updater.service  # systemd unit file
└── install.sh            # Script to install service + create directories

# Configuration (optional, currently unused - hardcoded ports)
# config/ - Reserved for future if ports become configurable
```

**Structure Decision**: Single Python project (Option 1) chosen because updater is a standalone backend service with no frontend. All code resides in `src/updater/` module for simplicity. Deployment files in `deploy/` separate from source for packaging clarity.

## Complexity Tracking

> **Fill ONLY if Constitution Check has violations that must be justified**

| Violation | Why Needed | Simpler Alternative Rejected Because |
|-----------|------------|-------------------------------------|
| Principle II: FastAPI + uvicorn + httpx (~15-20 packages) | Async I/O required for non-blocking concurrent operations: device-api sending download commands while ota-gui polls progress endpoint. Manual lock management in threading model (with stdlib `http.server`) error-prone and violates Principle I (simplicity = reliability). | Python stdlib `http.server` + `urllib`: Requires threading + manual locks for shared status state, blocking I/O for downloads prevents responsive /progress endpoint during large downloads, no built-in request validation (manual JSON parsing error-prone). Rejected because async model is *simpler* for this concurrent scenario. |
